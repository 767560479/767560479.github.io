import{_ as n,o as a,c as l,a as p}from"./app.7c6fd316.js";const D=JSON.parse('{"title":"深入剖析watchEffect源码设计","description":"","frontmatter":{"top":1,"sticky":1000,"sidebar":{"title":"深入剖析watchEffect源码设计","isTimeLine":true},"title":"深入剖析watchEffect源码设计","date":"2025-04-11T00:00:00.000Z","tags":["前端","javascript","源码","Vue3"],"categories":["前端"]},"headers":[{"level":2,"title":"一、源码定位与入口","slug":"一、源码定位与入口","link":"#一、源码定位与入口","children":[]},{"level":2,"title":"二、核心逻辑：doWatch 函数解析","slug":"二、核心逻辑-dowatch-函数解析","link":"#二、核心逻辑-dowatch-函数解析","children":[{"level":3,"title":"1. 参数处理与 Getter 生成","slug":"_1-参数处理与-getter-生成","link":"#_1-参数处理与-getter-生成","children":[]},{"level":3,"title":"2. 副作用实例创建","slug":"_2-副作用实例创建","link":"#_2-副作用实例创建","children":[]},{"level":3,"title":"3. 调度器（Scheduler）机制","slug":"_3-调度器-scheduler-机制","link":"#_3-调度器-scheduler-机制","children":[]}]},{"level":2,"title":"三、关键特性实现原理","slug":"三、关键特性实现原理","link":"#三、关键特性实现原理","children":[{"level":3,"title":"1. 自动依赖追踪","slug":"_1-自动依赖追踪","link":"#_1-自动依赖追踪","children":[]},{"level":3,"title":"2. 清理机制（onCleanup）","slug":"_2-清理机制-oncleanup","link":"#_2-清理机制-oncleanup","children":[]},{"level":3,"title":"3. 停止监听","slug":"_3-停止监听","link":"#_3-停止监听","children":[]}]},{"level":2,"title":"四、执行时机控制（flush 选项）","slug":"四、执行时机控制-flush-选项","link":"#四、执行时机控制-flush-选项","children":[]},{"level":2,"title":"五、设计亮点","slug":"五、设计亮点","link":"#五、设计亮点","children":[]},{"level":2,"title":"六、使用建议","slug":"六、使用建议","link":"#六、使用建议","children":[]}],"relativePath":"Vue3Source/深入剖析watchEffect源码设计.md","lastUpdated":1763393448000}'),e={name:"Vue3Source/深入剖析watchEffect源码设计.md"};function o(t,s,c,r,i,y){return a(),l("div",{"data-pagefind-body":!0},[...s[0]||(s[0]=[p(`<h1 id="深入剖析watcheffect源码设计" tabindex="-1">深入剖析watchEffect源码设计 <a class="header-anchor" href="#深入剖析watcheffect源码设计" aria-hidden="true">#</a></h1><p>在 Vue3 的响应式系统中，<code>watchEffect</code>是一个能够自动追踪依赖并执行副作用的神奇函数。本文将带您深入源码，解析其背后的实现机制。</p><hr><h2 id="一、源码定位与入口" tabindex="-1">一、源码定位与入口 <a class="header-anchor" href="#一、源码定位与入口" aria-hidden="true">#</a></h2><p>在<code>@vue/runtime-core</code>模块的<code>src/apiWatch.ts</code>中，<code>watchEffect</code>的实现仅有寥寥数行：</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 简化后代码</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">watchEffect</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#82AAFF;">effect</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">onCleanup</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">OnCleanup</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">void</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#BABED8;font-style:italic;">options</span><span style="color:#89DDFF;">?:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">WatchEffectOptions</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">WatchStopHandle</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">doWatch</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">options</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>其核心逻辑委托给<code>doWatch</code>函数，该函数同时服务于<code>watch</code>和<code>watchEffect</code>。</p><hr><h2 id="二、核心逻辑-dowatch-函数解析" tabindex="-1">二、核心逻辑：doWatch 函数解析 <a class="header-anchor" href="#二、核心逻辑-dowatch-函数解析" aria-hidden="true">#</a></h2><h3 id="_1-参数处理与-getter-生成" tabindex="-1">1. 参数处理与 Getter 生成 <a class="header-anchor" href="#_1-参数处理与-getter-生成" aria-hidden="true">#</a></h3><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">doWatch</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#BABED8;font-style:italic;">source</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">WatchSource</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">|</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">WatchSource</span><span style="color:#BABED8;">[]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#BABED8;font-style:italic;">cb</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">WatchCallback</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">|</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">immediate</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">flush</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">onTrack</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">onTrigger</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">WatchOptions</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> EMPTY_OBJ</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">WatchStopHandle</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 生成getter函数</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">cleanup</span><span style="color:#F07178;">) </span><span style="color:#82AAFF;">cleanup</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 执行effect函数，收集依赖</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">onTrack</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">onTrack</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">onTrigger</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">onTrigger</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">source</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>对于<code>watchEffect</code>，<code>source</code>是用户传入的副作用函数。每次执行<code>getter</code>时，都会调用该函数并触发响应式依赖收集。</p><h3 id="_2-副作用实例创建" tabindex="-1">2. 副作用实例创建 <a class="header-anchor" href="#_2-副作用实例创建" aria-hidden="true">#</a></h3><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> effect </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">ReactiveEffect</span><span style="color:#BABED8;">(getter</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> scheduler)</span></span>
<span class="line"><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#BABED8;">() </span><span style="color:#676E95;font-style:italic;">// 立即执行首次依赖收集</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>ReactiveEffect</code>是 Vue 响应系统的核心类，负责管理副作用执行和依赖追踪：</p><ul><li><strong>首次运行</strong>：立即执行<code>getter</code>，触发响应式属性的<code>get</code>操作，建立依赖关系</li><li><strong>依赖更新</strong>：通过 Proxy 的<code>track</code>和<code>trigger</code>机制追踪变化</li></ul><h3 id="_3-调度器-scheduler-机制" tabindex="-1">3. 调度器（Scheduler）机制 <a class="header-anchor" href="#_3-调度器-scheduler-机制" aria-hidden="true">#</a></h3><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> scheduler</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">EffectScheduler</span></span>
<span class="line"><span style="color:#82AAFF;">scheduler</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">active</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">cb</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#676E95;font-style:italic;">/* watch逻辑 */</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// watchEffect分支</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">() </span><span style="color:#676E95;font-style:italic;">// 直接重新运行副作用</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>当依赖变化时，调度器决定如何执行副作用。<code>watchEffect</code>直接重新运行原始函数，而<code>watch</code>会根据配置决定执行时机。</p><hr><h2 id="三、关键特性实现原理" tabindex="-1">三、关键特性实现原理 <a class="header-anchor" href="#三、关键特性实现原理" aria-hidden="true">#</a></h2><h3 id="_1-自动依赖追踪" tabindex="-1">1. 自动依赖追踪 <a class="header-anchor" href="#_1-自动依赖追踪" aria-hidden="true">#</a></h3><p>通过<code>ReactiveEffect</code>的<code>run</code>方法：</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ReactiveEffect</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">run</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">activeEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 设置为当前激活的effect</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">fn</span><span style="color:#F07178;">() </span><span style="color:#676E95;font-style:italic;">// 执行副作用函数</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">finally</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">activeEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>利用全局变量<code>activeEffect</code>，在响应式属性<code>get</code>操作时通过<code>track</code>函数建立依赖关系。</p><h3 id="_2-清理机制-oncleanup" tabindex="-1">2. 清理机制（onCleanup） <a class="header-anchor" href="#_2-清理机制-oncleanup" aria-hidden="true">#</a></h3><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> cleanup</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">void</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> onCleanup</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">OnCleanup</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">fn</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">void</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">cleanup</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onStop</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">fn</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>每次副作用执行前会先执行前一次的清理函数，避免异步操作导致的竞态问题。</p><h3 id="_3-停止监听" tabindex="-1">3. 停止监听 <a class="header-anchor" href="#_3-停止监听" aria-hidden="true">#</a></h3><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> stop </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">active</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stop</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 执行清理函数</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">cleanup</span><span style="color:#F07178;">) </span><span style="color:#82AAFF;">cleanup</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> stop</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>调用返回的停止函数后，将标记 effect 为未激活状态，后续依赖变化不再触发。</p><hr><h2 id="四、执行时机控制-flush-选项" tabindex="-1">四、执行时机控制（flush 选项） <a class="header-anchor" href="#四、执行时机控制-flush-选项" aria-hidden="true">#</a></h2><p>通过调度器配合任务队列实现不同的执行时机：</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> (flush </span><span style="color:#89DDFF;">===</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">sync</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">scheduler</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">job</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> (flush </span><span style="color:#89DDFF;">===</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">post</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">scheduler</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">queuePostRenderEffect</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">job</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">scheduler</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">queuePreFlushCb</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">job</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li><strong>pre</strong>：组件更新前执行</li><li><strong>post</strong>：组件更新后执行（默认）</li><li><strong>sync</strong>：同步立即执行</li></ul><hr><h2 id="五、设计亮点" tabindex="-1">五、设计亮点 <a class="header-anchor" href="#五、设计亮点" aria-hidden="true">#</a></h2><ol><li><strong>模块化设计</strong>：通过<code>doWatch</code>统一处理<code>watch</code>和<code>watchEffect</code>的核心逻辑</li><li><strong>懒依赖收集</strong>：仅在副作用执行时收集实际使用的依赖</li><li><strong>清理链式管理</strong>：通过闭包保存清理函数，确保异步操作的安全性</li><li><strong>高效调度</strong>：利用队列批处理避免重复执行</li></ol><hr><h2 id="六、使用建议" tabindex="-1">六、使用建议 <a class="header-anchor" href="#六、使用建议" aria-hidden="true">#</a></h2><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 典型用法</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> stop </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">watchEffect</span><span style="color:#BABED8;">(</span><span style="color:#BABED8;font-style:italic;">onCleanup</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">data</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">fetch</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">url</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">value</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">onCleanup</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">data</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">cancel</span><span style="color:#F07178;">())</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 组件卸载时自动清理</span></span>
<span class="line"><span style="color:#82AAFF;">onUnmounted</span><span style="color:#BABED8;">(stop)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><hr><p>通过剖析源码可见，<code>watchEffect</code>的精妙之处在于将响应式追踪与副作用管理完美结合。这种设计既保证了开发便利性，又通过底层优化确保了运行效率，充分体现了 Vue3 响应式系统的精妙设计。</p>`,44)])])}const d=n(e,[["render",o]]);export{D as __pageData,d as default};
