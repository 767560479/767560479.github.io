import{_ as n,o as a,c as l,a as p}from"./app.f86949ad.js";const B=JSON.parse('{"title":"WPF 的 MVVM 模式","description":"","frontmatter":{},"headers":[{"level":2,"title":"1. MVVM 基础概念回顾","slug":"_1-mvvm-基础概念回顾","link":"#_1-mvvm-基础概念回顾","children":[{"level":3,"title":"1.1 什么是 MVVM？","slug":"_1-1-什么是-mvvm","link":"#_1-1-什么是-mvvm","children":[]},{"level":3,"title":"1.2 各层职责","slug":"_1-2-各层职责","link":"#_1-2-各层职责","children":[]}]},{"level":2,"title":"2. ViewModel 实现详解","slug":"_2-viewmodel-实现详解","link":"#_2-viewmodel-实现详解","children":[{"level":3,"title":"2.1 INotifyPropertyChanged 接口","slug":"_2-1-inotifypropertychanged-接口","link":"#_2-1-inotifypropertychanged-接口","children":[]},{"level":3,"title":"2.2 完整的 ViewModel 示例","slug":"_2-2-完整的-viewmodel-示例","link":"#_2-2-完整的-viewmodel-示例","children":[]}]},{"level":2,"title":"3. 命令绑定 (ICommand)","slug":"_3-命令绑定-icommand","link":"#_3-命令绑定-icommand","children":[{"level":3,"title":"3.1 RelayCommand 实现","slug":"_3-1-relaycommand-实现","link":"#_3-1-relaycommand-实现","children":[]}]},{"level":2,"title":"4. 数据绑定深度解析","slug":"_4-数据绑定深度解析","link":"#_4-数据绑定深度解析","children":[{"level":3,"title":"4.1 绑定模式","slug":"_4-1-绑定模式","link":"#_4-1-绑定模式","children":[]},{"level":3,"title":"4.2 值转换器 (IValueConverter)","slug":"_4-2-值转换器-ivalueconverter","link":"#_4-2-值转换器-ivalueconverter","children":[]},{"level":3,"title":"4.3 数据验证","slug":"_4-3-数据验证","link":"#_4-3-数据验证","children":[]}]},{"level":2,"title":"5. 高级 MVVM 模式","slug":"_5-高级-mvvm-模式","link":"#_5-高级-mvvm-模式","children":[{"level":3,"title":"5.1 消息传递 (Messenger Pattern)","slug":"_5-1-消息传递-messenger-pattern","link":"#_5-1-消息传递-messenger-pattern","children":[]},{"level":3,"title":"5.2 依赖注入在 MVVM 中的应用","slug":"_5-2-依赖注入在-mvvm-中的应用","link":"#_5-2-依赖注入在-mvvm-中的应用","children":[]}]},{"level":2,"title":"6. 常见陷阱与最佳实践","slug":"_6-常见陷阱与最佳实践","link":"#_6-常见陷阱与最佳实践","children":[{"level":3,"title":"6.1 内存泄漏预防","slug":"_6-1-内存泄漏预防","link":"#_6-1-内存泄漏预防","children":[]},{"level":3,"title":"6.2 异步编程模式","slug":"_6-2-异步编程模式","link":"#_6-2-异步编程模式","children":[]}]},{"level":2,"title":"7. 测试 MVVM 应用程序","slug":"_7-测试-mvvm-应用程序","link":"#_7-测试-mvvm-应用程序","children":[{"level":3,"title":"7.1 ViewModel 单元测试","slug":"_7-1-viewmodel-单元测试","link":"#_7-1-viewmodel-单元测试","children":[]}]}],"relativePath":"C#/WPF的MVVM模式.md","lastUpdated":1764085184000}'),o={name:"C#/WPF的MVVM模式.md"};function e(r,s,c,t,D,y){return a(),l("div",null,[...s[0]||(s[0]=[p(`<h1 id="wpf-的-mvvm-模式" tabindex="-1">WPF 的 MVVM 模式 <a class="header-anchor" href="#wpf-的-mvvm-模式" aria-hidden="true">#</a></h1><h1 id="wpf-mvvm-模式全面复习与查缺补漏" tabindex="-1">WPF MVVM 模式全面复习与查缺补漏 <a class="header-anchor" href="#wpf-mvvm-模式全面复习与查缺补漏" aria-hidden="true">#</a></h1><h2 id="_1-mvvm-基础概念回顾" tabindex="-1">1. MVVM 基础概念回顾 <a class="header-anchor" href="#_1-mvvm-基础概念回顾" aria-hidden="true">#</a></h2><h3 id="_1-1-什么是-mvvm" tabindex="-1">1.1 什么是 MVVM？ <a class="header-anchor" href="#_1-1-什么是-mvvm" aria-hidden="true">#</a></h3><p>MVVM（Model-View-ViewModel）是一种软件架构模式，专门为 WPF 和 Silverlight 等 XAML-based 应用程序设计。</p><div class="language-csharp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// MVVM 三大组件关系</span></span>
<span class="line"><span style="color:#BABED8;">Model ←→ ViewModel ←→ View</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_1-2-各层职责" tabindex="-1">1.2 各层职责 <a class="header-anchor" href="#_1-2-各层职责" aria-hidden="true">#</a></h3><p><strong>Model（模型）</strong></p><ul><li>表示业务数据和业务逻辑</li><li>不包含任何 UI 相关代码</li><li>通常包含数据验证逻辑</li></ul><p><strong>View（视图）</strong></p><ul><li>用户界面定义</li><li>仅包含展示逻辑</li><li>通过数据绑定与 ViewModel 交互</li></ul><p><strong>ViewModel（视图模型）</strong></p><ul><li>View 的抽象表示</li><li>包含命令和可绑定属性</li><li>协调 Model 和 View 之间的交互</li></ul><h2 id="_2-viewmodel-实现详解" tabindex="-1">2. ViewModel 实现详解 <a class="header-anchor" href="#_2-viewmodel-实现详解" aria-hidden="true">#</a></h2><h3 id="_2-1-inotifypropertychanged-接口" tabindex="-1">2.1 INotifyPropertyChanged 接口 <a class="header-anchor" href="#_2-1-inotifypropertychanged-接口" aria-hidden="true">#</a></h3><div class="language-csharp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#F78C6C;">using</span><span style="color:#BABED8;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">ComponentModel</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">using</span><span style="color:#BABED8;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Runtime</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">CompilerServices</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">abstract</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ViewModelBase</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">INotifyPropertyChanged</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">event</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">PropertyChangedEventHandler</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">PropertyChanged</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">protected</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">virtual</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">OnPropertyChanged</span><span style="color:#89DDFF;">([</span><span style="color:#FFCB6B;">CallerMemberName</span><span style="color:#89DDFF;">]</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">propertyName</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        PropertyChanged</span><span style="color:#89DDFF;">?.</span><span style="color:#82AAFF;">Invoke</span><span style="color:#89DDFF;">(this,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">PropertyChangedEventArgs</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">propertyName</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">protected</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">bool</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">SetProperty</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#C792EA;">ref</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">field</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">value</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">CallerMemberName</span><span style="color:#89DDFF;">]</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">propertyName</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">EqualityComparer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;.</span><span style="color:#BABED8;">Default</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Equals</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">field</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">            </span></span>
<span class="line"><span style="color:#BABED8;">        field </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#82AAFF;">OnPropertyChanged</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">propertyName</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="_2-2-完整的-viewmodel-示例" tabindex="-1">2.2 完整的 ViewModel 示例 <a class="header-anchor" href="#_2-2-完整的-viewmodel-示例" aria-hidden="true">#</a></h3><div class="language-csharp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">UserViewModel</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ViewModelBase</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_name</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_email</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ObservableCollection</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">User</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_users</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Name</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">get</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> _name</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">set</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">SetProperty</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">ref</span><span style="color:#BABED8;"> _name</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Email</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">get</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> _email</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">set</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">SetProperty</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">ref</span><span style="color:#BABED8;"> _email</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ObservableCollection</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">User</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Users</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">get</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> _users</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">set</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">SetProperty</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">ref</span><span style="color:#BABED8;"> _users</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ICommand</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">AddUserCommand</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">get</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ICommand</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">DeleteUserCommand</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">get</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">UserViewModel</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        Users </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ObservableCollection</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">User</span><span style="color:#89DDFF;">&gt;();</span></span>
<span class="line"><span style="color:#BABED8;">        AddUserCommand </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">RelayCommand</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">AddUser</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> CanAddUser</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">        DeleteUserCommand </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">RelayCommand</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">User</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#BABED8;">DeleteUser</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">AddUser</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">var</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">user</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">User</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> Name </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> Name</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> Email </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> Email </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#BABED8;">        Users</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Add</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">user</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">        Name </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Empty</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        Email </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Empty</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">bool</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">CanAddUser</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">!</span><span style="color:#89DDFF;">string</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">IsNullOrWhiteSpace</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">Name</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#BABED8;"> </span></span>
<span class="line"><span style="color:#BABED8;">               </span><span style="color:#89DDFF;">!</span><span style="color:#89DDFF;">string</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">IsNullOrWhiteSpace</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">Email</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">DeleteUser</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">User</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">user</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">user </span><span style="color:#89DDFF;">!=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#BABED8;">            Users</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Remove</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">user</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h2 id="_3-命令绑定-icommand" tabindex="-1">3. 命令绑定 (ICommand) <a class="header-anchor" href="#_3-命令绑定-icommand" aria-hidden="true">#</a></h2><h3 id="_3-1-relaycommand-实现" tabindex="-1">3.1 RelayCommand 实现 <a class="header-anchor" href="#_3-1-relaycommand-实现" aria-hidden="true">#</a></h3><div class="language-csharp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">RelayCommand</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ICommand</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Action</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_execute</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Func</span><span style="color:#89DDFF;">&lt;bool&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_canExecute</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">RelayCommand</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Action</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">execute</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Func</span><span style="color:#89DDFF;">&lt;bool&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">canExecute</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        _execute </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> execute </span><span style="color:#89DDFF;">??</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">throw</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ArgumentNullException</span><span style="color:#89DDFF;">(nameof(</span><span style="color:#BABED8;">execute</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#BABED8;">        _canExecute </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> canExecute</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">event</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">EventHandler</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">CanExecuteChanged</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">add</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> CommandManager</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">RequerySuggested </span><span style="color:#89DDFF;">+=</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">remove</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> CommandManager</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">RequerySuggested </span><span style="color:#89DDFF;">-=</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">bool</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">CanExecute</span><span style="color:#89DDFF;">(object</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">parameter</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> _canExecute</span><span style="color:#89DDFF;">?.</span><span style="color:#82AAFF;">Invoke</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">??</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Execute</span><span style="color:#89DDFF;">(object</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">parameter</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">_execute</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 泛型版本</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">RelayCommand</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ICommand</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Action</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_execute</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Func</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">bool&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_canExecute</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">RelayCommand</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Action</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">execute</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Func</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">bool&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">canExecute</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        _execute </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> execute </span><span style="color:#89DDFF;">??</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">throw</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ArgumentNullException</span><span style="color:#89DDFF;">(nameof(</span><span style="color:#BABED8;">execute</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#BABED8;">        _canExecute </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> canExecute</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">event</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">EventHandler</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">CanExecuteChanged</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">add</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> CommandManager</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">RequerySuggested </span><span style="color:#89DDFF;">+=</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">remove</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> CommandManager</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">RequerySuggested </span><span style="color:#89DDFF;">-=</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">bool</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">CanExecute</span><span style="color:#89DDFF;">(object</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">parameter</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> _canExecute</span><span style="color:#89DDFF;">?.</span><span style="color:#82AAFF;">Invoke</span><span style="color:#89DDFF;">((</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;">parameter</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">??</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Execute</span><span style="color:#89DDFF;">(object</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">parameter</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">_execute</span><span style="color:#89DDFF;">((</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;">parameter</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h2 id="_4-数据绑定深度解析" tabindex="-1">4. 数据绑定深度解析 <a class="header-anchor" href="#_4-数据绑定深度解析" aria-hidden="true">#</a></h2><h3 id="_4-1-绑定模式" tabindex="-1">4.1 绑定模式 <a class="header-anchor" href="#_4-1-绑定模式" aria-hidden="true">#</a></h3><div class="language-xml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">&lt;!-- 各种绑定模式示例 --&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">TextBox</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">Text</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">TextBlock</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">Text</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">{Binding Email, Mode=OneWay}</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">ListBox</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">ItemsSource</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">{Binding Users, Mode=OneWay}</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">ContentControl</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">Content</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">{Binding SelectedItem, Mode=OneWayToSource}</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_4-2-值转换器-ivalueconverter" tabindex="-1">4.2 值转换器 (IValueConverter) <a class="header-anchor" href="#_4-2-值转换器-ivalueconverter" aria-hidden="true">#</a></h3><div class="language-csharp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">BooleanToVisibilityConverter</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">IValueConverter</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">object</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Convert</span><span style="color:#89DDFF;">(object</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">value</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Type</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">targetType</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">object</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">parameter</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">CultureInfo</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">culture</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">value </span><span style="color:#89DDFF;">is</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">bool</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">boolValue</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#BABED8;"> boolValue</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">?</span><span style="color:#BABED8;"> </span></span>
<span class="line"><span style="color:#BABED8;">            Visibility</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Visible </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> Visibility</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Collapsed</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">object</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">ConvertBack</span><span style="color:#89DDFF;">(object</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">value</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Type</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">targetType</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">object</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">parameter</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">CultureInfo</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">culture</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> value </span><span style="color:#89DDFF;">is</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Visibility</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">visibility</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#BABED8;"> visibility </span><span style="color:#89DDFF;">==</span><span style="color:#BABED8;"> Visibility</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Visible</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 在 XAML 中使用</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#BABED8;">Window</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Resources</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">local</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;">BooleanToVisibilityConverter </span><span style="color:#FFCB6B;">x</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;">Key</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">BoolToVisibilityConverter</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#BABED8;">Window</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Resources</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#BABED8;">Button Visibility</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">{Binding IsEnabled, Converter={StaticResource BoolToVisibilityConverter}}</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_4-3-数据验证" tabindex="-1">4.3 数据验证 <a class="header-anchor" href="#_4-3-数据验证" aria-hidden="true">#</a></h3><div class="language-csharp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">User</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">IDataErrorInfo</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Name</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">get</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">set</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Email</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">get</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">set</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">this[</span><span style="color:#89DDFF;">string</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">columnName</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">get</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#89DDFF;font-style:italic;">switch</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">columnName</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">nameof(</span><span style="color:#BABED8;">Name</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#BABED8;">                    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">string</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">IsNullOrWhiteSpace</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">Name</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#BABED8;">                        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">姓名不能为空</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">                    </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">nameof(</span><span style="color:#BABED8;">Email</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#BABED8;">                    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">string</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">IsNullOrWhiteSpace</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">Email</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#BABED8;">                        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">邮箱不能为空</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">                    </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#BABED8;">Regex</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">IsMatch</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">Email</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">@&quot;</span><span style="color:#C3E88D;">^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#BABED8;">                        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">邮箱格式不正确</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">                    </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Error</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="_5-高级-mvvm-模式" tabindex="-1">5. 高级 MVVM 模式 <a class="header-anchor" href="#_5-高级-mvvm-模式" aria-hidden="true">#</a></h2><h3 id="_5-1-消息传递-messenger-pattern" tabindex="-1">5.1 消息传递 (Messenger Pattern) <a class="header-anchor" href="#_5-1-消息传递-messenger-pattern" aria-hidden="true">#</a></h3><div class="language-csharp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Messenger</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">static</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Dictionary</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Type</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Action</span><span style="color:#89DDFF;">&lt;object&gt;&gt;&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_actions</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Dictionary</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Type</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Action</span><span style="color:#89DDFF;">&lt;object&gt;&gt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">static</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Register</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#FFCB6B;">Action</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">action</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">var</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">type</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">typeof(</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#BABED8;">_actions</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ContainsKey</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">type</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#BABED8;">            _actions</span><span style="color:#89DDFF;">[</span><span style="color:#BABED8;">type</span><span style="color:#89DDFF;">]</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Action</span><span style="color:#89DDFF;">&lt;object&gt;&gt;();</span></span>
<span class="line"><span style="color:#BABED8;">            </span></span>
<span class="line"><span style="color:#BABED8;">        _actions</span><span style="color:#89DDFF;">[</span><span style="color:#BABED8;">type</span><span style="color:#89DDFF;">].</span><span style="color:#82AAFF;">Add</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">obj</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">action</span><span style="color:#89DDFF;">((</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;">obj</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">static</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Send</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#FFCB6B;">T</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">message</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">var</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">type</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">typeof(</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">_actions</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ContainsKey</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">type</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#89DDFF;font-style:italic;">foreach</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">var</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">action</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#BABED8;"> _actions</span><span style="color:#89DDFF;">[</span><span style="color:#BABED8;">type</span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#82AAFF;">action</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">message</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 使用示例</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">UserAddedMessage</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">User</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">User</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">get</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">set</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 发送消息</span></span>
<span class="line"><span style="color:#BABED8;">Messenger</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Send</span><span style="color:#89DDFF;">(new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">UserAddedMessage</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> User </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> newUser </span><span style="color:#89DDFF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 接收消息</span></span>
<span class="line"><span style="color:#BABED8;">Messenger</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Register</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">UserAddedMessage</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#FFCB6B;">message</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    </span><span style="color:#676E95;font-style:italic;">// 处理新用户添加逻辑</span></span>
<span class="line"><span style="color:#89DDFF;">});</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h3 id="_5-2-依赖注入在-mvvm-中的应用" tabindex="-1">5.2 依赖注入在 MVVM 中的应用 <a class="header-anchor" href="#_5-2-依赖注入在-mvvm-中的应用" aria-hidden="true">#</a></h3><div class="language-csharp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">interface</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">IUserService</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">AddUser</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">User</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">user</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#FFCB6B;">IEnumerable</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">User</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">GetUsers</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">UserService</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">IUserService</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">AddUser</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">User</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">user</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">/* 实现 */</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">IEnumerable</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">User</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">GetUsers</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">/* 实现 */</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">UserViewModel</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ViewModelBase</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">IUserService</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_userService</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">UserViewModel</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">IUserService</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">userService</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        _userService </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> userService</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="_6-常见陷阱与最佳实践" tabindex="-1">6. 常见陷阱与最佳实践 <a class="header-anchor" href="#_6-常见陷阱与最佳实践" aria-hidden="true">#</a></h2><h3 id="_6-1-内存泄漏预防" tabindex="-1">6.1 内存泄漏预防 <a class="header-anchor" href="#_6-1-内存泄漏预防" aria-hidden="true">#</a></h3><div class="language-csharp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 错误示例 - 可能导致内存泄漏</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">LeakyViewModel</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">event</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">EventHandler</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">SomethingHappened</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    </span><span style="color:#676E95;font-style:italic;">// 如果没有正确注销事件，可能导致内存泄漏</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 正确做法</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">SafeViewModel</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ViewModelBase</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">IDisposable</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">bool</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_disposed</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Dispose</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#BABED8;">_disposed</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">            </span><span style="color:#676E95;font-style:italic;">// 清理资源、注销事件</span></span>
<span class="line"><span style="color:#BABED8;">            _disposed </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">    </span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">~</span><span style="color:#82AAFF;">SafeViewModel</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#82AAFF;">Dispose</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="_6-2-异步编程模式" tabindex="-1">6.2 异步编程模式 <a class="header-anchor" href="#_6-2-异步编程模式" aria-hidden="true">#</a></h3><div class="language-csharp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">AsyncViewModel</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ViewModelBase</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">IUserService</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_userService</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">bool</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_isLoading</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_statusMessage</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">bool</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">IsLoading</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">get</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> _isLoading</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">set</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">SetProperty</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">ref</span><span style="color:#BABED8;"> _isLoading</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">StatusMessage</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">get</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> _statusMessage</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">set</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">SetProperty</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">ref</span><span style="color:#BABED8;"> _statusMessage</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">IAsyncCommand</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">LoadUsersCommand</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">get</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">AsyncViewModel</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">IUserService</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">userService</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        _userService </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> userService</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        LoadUsersCommand </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">AsyncRelayCommand</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">LoadUsersAsync</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">async</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Task</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">LoadUsersAsync</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">try</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">            IsLoading </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">            StatusMessage </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">正在加载用户...</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">            </span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#FFCB6B;">var</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">users</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">await</span><span style="color:#BABED8;"> _userService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">GetUsersAsync</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">            </span><span style="color:#676E95;font-style:italic;">// 处理用户数据</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">catch</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Exception</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ex</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">            StatusMessage </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">$&quot;</span><span style="color:#C3E88D;">加载失败: </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;">ex</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Message</span><span style="color:#89DDFF;">}&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">finally</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">            IsLoading </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 异步命令实现</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">AsyncRelayCommand</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ICommand</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Func</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Task</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_execute</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Func</span><span style="color:#89DDFF;">&lt;bool&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_canExecute</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">bool</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">_isExecuting</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">AsyncRelayCommand</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Func</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Task</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">execute</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Func</span><span style="color:#89DDFF;">&lt;bool&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">canExecute</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        _execute </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> execute</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        _canExecute </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> canExecute</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">bool</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">CanExecute</span><span style="color:#89DDFF;">(object</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">parameter</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">_isExecuting </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">_canExecute</span><span style="color:#89DDFF;">?.</span><span style="color:#82AAFF;">Invoke</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">??</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">async</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Execute</span><span style="color:#89DDFF;">(object</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">parameter</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        _isExecuting </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#82AAFF;">OnCanExecuteChanged</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">        </span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">try</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#89DDFF;">await</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">_execute</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">finally</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">            _isExecuting </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#82AAFF;">OnCanExecuteChanged</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">event</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">EventHandler</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">CanExecuteChanged</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    </span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">protected</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">virtual</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">OnCanExecuteChanged</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        CanExecuteChanged</span><span style="color:#89DDFF;">?.</span><span style="color:#82AAFF;">Invoke</span><span style="color:#89DDFF;">(this,</span><span style="color:#BABED8;"> EventArgs</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Empty</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br></div></div><h2 id="_7-测试-mvvm-应用程序" tabindex="-1">7. 测试 MVVM 应用程序 <a class="header-anchor" href="#_7-测试-mvvm-应用程序" aria-hidden="true">#</a></h2><h3 id="_7-1-viewmodel-单元测试" tabindex="-1">7.1 ViewModel 单元测试 <a class="header-anchor" href="#_7-1-viewmodel-单元测试" aria-hidden="true">#</a></h3><div class="language-csharp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">TestFixture</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">UserViewModelTests</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">AddUserCommand_WhenDataValid_AddsUserToCollection</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        </span><span style="color:#676E95;font-style:italic;">// Arrange</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">var</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">viewModel</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">UserViewModel</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">        viewModel</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Name </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Test User</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        viewModel</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Email </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test@example.com</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        </span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        </span><span style="color:#676E95;font-style:italic;">// Act</span></span>
<span class="line"><span style="color:#BABED8;">        viewModel</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">AddUserCommand</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Execute</span><span style="color:#89DDFF;">(null);</span></span>
<span class="line"><span style="color:#BABED8;">        </span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        </span><span style="color:#676E95;font-style:italic;">// Assert</span></span>
<span class="line"><span style="color:#BABED8;">        Assert</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AreEqual</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> viewModel</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Users</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Count</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">        Assert</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AreEqual</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Test User</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> viewModel</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Users</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">].</span><span style="color:#BABED8;">Name</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">    </span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">CanAddUser_WhenNameEmpty_ReturnsFalse</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        </span><span style="color:#676E95;font-style:italic;">// Arrange</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">var</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">viewModel</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">UserViewModel</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">        viewModel</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Name </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">string</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Empty</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        viewModel</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Email </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test@example.com</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">        </span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        </span><span style="color:#676E95;font-style:italic;">// Act &amp; Assert</span></span>
<span class="line"><span style="color:#BABED8;">        Assert</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">IsFalse</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">viewModel</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">AddUserCommand</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">CanExecute</span><span style="color:#89DDFF;">(null));</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div>`,41)])])}const i=n(o,[["render",e]]);export{B as __pageData,i as default};
