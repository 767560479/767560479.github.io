import{_ as p,o,c,a as l,b as n,d as a,t as r}from"./app.7c6fd316.js";const B=JSON.parse('{"title":"ref源码方法解读","description":"","frontmatter":{"top":2,"sticky":1000,"sidebar":{"title":"ref源码方法解读","isTimeLine":true},"title":"ref源码方法解读","date":"2025-04-06T00:00:00.000Z","tags":["前端","javascript","源码","Vue3"],"categories":["前端"]},"headers":[{"level":2,"title":"一、ref 的基本使用","slug":"一、ref-的基本使用","link":"#一、ref-的基本使用","children":[]},{"level":2,"title":"二、ref 的源码解读","slug":"二、ref-的源码解读","link":"#二、ref-的源码解读","children":[{"level":3,"title":"1. ref 函数的定义","slug":"_1-ref-函数的定义","link":"#_1-ref-函数的定义","children":[]},{"level":3,"title":"2. RefImpl 类：核心实现","slug":"_2-refimpl-类-核心实现","link":"#_2-refimpl-类-核心实现","children":[]},{"level":3,"title":"3. 依赖收集与触发","slug":"_3-依赖收集与触发","link":"#_3-依赖收集与触发","children":[]}]},{"level":2,"title":"三、结合使用示例深入理解","slug":"三、结合使用示例深入理解","link":"#三、结合使用示例深入理解","children":[{"level":3,"title":"示例 1：基本计数器","slug":"示例-1-基本计数器","link":"#示例-1-基本计数器","children":[]},{"level":3,"title":"示例 2：对象类型的 ref","slug":"示例-2-对象类型的-ref","link":"#示例-2-对象类型的-ref","children":[]}]},{"level":2,"title":"四、注意事项与源码启发","slug":"四、注意事项与源码启发","link":"#四、注意事项与源码启发","children":[]},{"level":2,"title":"五、总结","slug":"五、总结","link":"#五、总结","children":[]}],"relativePath":"Vue3Source/ref源码方法解读.md","lastUpdated":1763393448000}'),t={name:"Vue3Source/ref源码方法解读.md"};function i(e,s,y,F,D,d){return o(),c("div",{"data-pagefind-body":!0},[s[7]||(s[7]=l(`<h1 id="vue-3-ref-源码方法解读-从使用到实现" tabindex="-1">Vue 3 ref 源码方法解读：从使用到实现 <a class="header-anchor" href="#vue-3-ref-源码方法解读-从使用到实现" aria-hidden="true">#</a></h1><p>在 Vue 3 中，<code>ref</code> 是 Composition API 的核心特性之一，用于创建响应式数据。它简单易用，但背后却蕴含了 Vue 响应式系统的精妙设计。本文将结合使用示例，深入剖析 <code>ref</code> 的源码实现，帮助你理解它的原理。</p><h2 id="一、ref-的基本使用" tabindex="-1">一、<code>ref</code> 的基本使用 <a class="header-anchor" href="#一、ref-的基本使用" aria-hidden="true">#</a></h2><p>先来看看 <code>ref</code> 的基本用法：</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">ref</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">vue</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">setup</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">count</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">ref</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// 创建一个响应式引用</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">increment</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">count</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">value</span><span style="color:#89DDFF;">++</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 通过 .value 修改值</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">count</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">increment</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在模板中，我们可以直接使用 <code>count</code>：</p><div class="language-html line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">p</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;">Count: {{ count }}</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">p</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">button</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">@click</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">increment</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;">加 1</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">button</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>运行这段代码，点击按钮时，<code>count</code> 会从 0 递增，并且页面会自动更新。表面上看，<code>ref</code> 只是一个简单的封装，但它是如何实现响应式的呢？接下来我们深入源码。</p><hr><h2 id="二、ref-的源码解读" tabindex="-1">二、<code>ref</code> 的源码解读 <a class="header-anchor" href="#二、ref-的源码解读" aria-hidden="true">#</a></h2><p>Vue 3 的源码中，<code>ref</code> 的实现主要位于 <code>packages/reactivity/src/ref.ts</code> 文件中。我们逐步拆解其核心逻辑。</p><h3 id="_1-ref-函数的定义" tabindex="-1">1. <code>ref</code> 函数的定义 <a class="header-anchor" href="#_1-ref-函数的定义" aria-hidden="true">#</a></h3><p><code>ref</code> 是一个工厂函数，接收一个初始值并返回一个 <code>Ref</code> 对象：</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">ref</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#BABED8;font-style:italic;">value</span><span style="color:#89DDFF;">?:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">):</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Ref</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createRef</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">value</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里调用了内部的 <code>createRef</code> 函数，第二个参数 <code>false</code> 表示这不是 <code>shallowRef</code>（浅层响应式）。我们继续看 <code>createRef</code>：</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">createRef</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#BABED8;font-style:italic;">rawValue</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">shallow</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#89DDFF;">):</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Ref</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isRef</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">rawValue</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">rawValue</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 如果传入的是一个 ref，直接返回</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">RefImpl</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">rawValue</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">shallow</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>createRef</code> 首先检查传入的值是否已经是 <code>Ref</code> 类型（通过 <code>isRef</code> 判断），如果是则直接返回，否则创建一个 <code>RefImpl</code> 实例。</p><h3 id="_2-refimpl-类-核心实现" tabindex="-1">2. <code>RefImpl</code> 类：核心实现 <a class="header-anchor" href="#_2-refimpl-类-核心实现" aria-hidden="true">#</a></h3><p><code>RefImpl</code> 是 <code>ref</code> 的核心实现类：</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">RefImpl</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">_value</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">T</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">dep</span><span style="color:#89DDFF;">?:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Dep</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">undefined</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// 依赖收集的容器</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">__v_isRef</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// 标记这是一个 ref</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">constructor</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">value</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">_shallow</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">_value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">_shallow</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">toReactive</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">value</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// 初始化值</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">get</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">trackRefValue</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// 依赖收集</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">_value</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">set</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">newVal</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">hasChanged</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">newVal</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">_value</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// 值发生变化时</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">_value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">_shallow</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">newVal</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">toReactive</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">newVal</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">triggerRefValue</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// 触发更新</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="关键点解析" tabindex="-1">关键点解析： <a class="header-anchor" href="#关键点解析" aria-hidden="true">#</a></h4><ul><li><p><strong>属性</strong>：</p><ul><li><code>_value</code>：存储实际的值。</li><li><code>dep</code>：用于存储依赖（即哪些地方用到了这个 <code>ref</code>）。</li><li><code>__v_isRef</code>：标记这是一个 <code>ref</code>，方便 <code>isRef</code> 判断。</li></ul></li><li><p><strong>构造函数</strong>：</p><ul><li>如果是普通 <code>ref</code>（非浅层），会通过 <code>toReactive</code> 将值转为响应式对象（对于对象类型会调用 <code>reactive</code>）。</li><li>如果是 <code>shallowRef</code>，则直接使用原始值。</li></ul></li><li><p><strong><code>get value</code></strong>：</p><ul><li>当访问 <code>.value</code> 时，调用 <code>trackRefValue</code> 进行依赖收集。</li><li>返回 <code>_value</code>。</li></ul></li><li><p><strong><code>set value</code></strong>：</p><ul><li>当修改 <code>.value</code> 时，先通过 <code>hasChanged</code> 检查新旧值是否不同。</li><li>如果不同，更新 <code>_value</code>，并通过 <code>triggerRefValue</code> 触发依赖更新。</li></ul></li></ul><h3 id="_3-依赖收集与触发" tabindex="-1">3. 依赖收集与触发 <a class="header-anchor" href="#_3-依赖收集与触发" aria-hidden="true">#</a></h3><ul><li><strong><code>trackRefValue</code></strong>：</li></ul><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">trackRefValue</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">ref</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">shouldTrack</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">activeEffect</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">ref</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">dep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">ref</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">dep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Dep</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">ref</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">dep</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">activeEffect</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>当 <code>ref.value</code> 被访问时，如果当前有活跃的 <code>effect</code>（如 <code>watchEffect</code> 或组件渲染），会将这个 <code>effect</code> 加入 <code>ref.dep</code> 中，实现依赖收集。</p><ul><li><strong><code>triggerRefValue</code></strong>：</li></ul><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">triggerRefValue</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">ref</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">ref</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">dep</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">triggerEffects</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">ref</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">dep</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当 <code>ref.value</code> 被修改时，触发 <code>ref.dep</code> 中的所有依赖，通知它们更新。</p><hr><h2 id="三、结合使用示例深入理解" tabindex="-1">三、结合使用示例深入理解 <a class="header-anchor" href="#三、结合使用示例深入理解" aria-hidden="true">#</a></h2><h3 id="示例-1-基本计数器" tabindex="-1">示例 1：基本计数器 <a class="header-anchor" href="#示例-1-基本计数器" aria-hidden="true">#</a></h3><p>回到开头的例子：</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> count </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">ref</span><span style="color:#BABED8;">(</span><span style="color:#F78C6C;">0</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> increment </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">count</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">value</span><span style="color:#89DDFF;">++</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div>`,34)),n("ul",null,[s[5]||(s[5]=n("li",null,[n("strong",null,"初始化"),a("："),n("code",null,"ref(0)"),a(" 创建一个 "),n("code",null,"RefImpl"),a(" 实例，"),n("code",null,"_value"),a(" 为 0。")],-1)),n("li",null,[s[0]||(s[0]=n("strong",null,"访问",-1)),s[1]||(s[1]=a("：模板中 ",-1)),n("code",null,r(e.count),1),s[2]||(s[2]=a(" 会触发 ",-1)),s[3]||(s[3]=n("code",null,"get value",-1)),s[4]||(s[4]=a("，收集渲染函数作为依赖。",-1))]),s[6]||(s[6]=n("li",null,[n("strong",null,"修改"),a("："),n("code",null,"count.value++"),a(" 触发 "),n("code",null,"set value"),a("，值变为 1，"),n("code",null,"triggerRefValue"),a(" 通知渲染函数更新页面。")],-1))]),s[8]||(s[8]=l(`<h3 id="示例-2-对象类型的-ref" tabindex="-1">示例 2：对象类型的 <code>ref</code> <a class="header-anchor" href="#示例-2-对象类型的-ref" aria-hidden="true">#</a></h3><p><code>ref</code> 不仅支持基本类型，还支持对象：</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> user </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">ref</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Alice</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">age</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">25</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> updateAge </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#BABED8;">user</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">value</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">age</span><span style="color:#89DDFF;">++</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 修改嵌套属性</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><strong>初始化</strong>：<code>toReactive</code> 将 <code>{ name: &#39;Alice&#39;, age: 25 }</code> 转为 <code>reactive</code> 对象。</li><li><strong>访问</strong>：<code>user.value.age</code> 会触发 <code>reactive</code> 的 getter，收集依赖。</li><li><strong>修改</strong>：<code>user.value.age++</code> 触发 <code>reactive</code> 的 setter，自动更新。</li></ul><p>这里 <code>ref</code> 和 <code>reactive</code> 的结合非常巧妙，<code>ref</code> 的 <code>_value</code> 是一个 <code>reactive</code> 对象，嵌套属性的响应式由 <code>reactive</code> 接管。</p><hr><h2 id="四、注意事项与源码启发" tabindex="-1">四、注意事项与源码启发 <a class="header-anchor" href="#四、注意事项与源码启发" aria-hidden="true">#</a></h2><ol><li><p><strong><code>.value</code> 的必要性</strong>：</p><ul><li>在 <code>setup</code> 中需要手动写 <code>.value</code>，但模板中不需要，因为 Vue 在编译时会自动解包 <code>ref</code>。</li><li>源码中，<code>ref</code> 的设计是为了在 JS 中保持显式性。</li></ul></li><li><p><strong>性能优化</strong>：</p><ul><li><code>hasChanged</code> 避免了不必要的更新。</li><li><code>shallowRef</code> 提供了浅层响应式选项，适合大数据场景。</li></ul></li><li><p><strong>与 <code>reactive</code> 的区别</strong>：</p><ul><li><code>ref</code> 适用于单一值或需要显式解包的场景。</li><li><code>reactive</code> 更适合复杂对象，省去 <code>.value</code>。</li></ul></li></ol><hr><h2 id="五、总结" tabindex="-1">五、总结 <a class="header-anchor" href="#五、总结" aria-hidden="true">#</a></h2><p>通过源码分析，我们看到 <code>ref</code> 的实现并不复杂，但它巧妙地结合了 getter/setter 和依赖收集机制，实现了响应式。无论是基本类型还是对象，<code>ref</code> 都能无缝衔接 Vue 的响应式系统。希望这篇文章能帮助你更深入地理解 <code>ref</code>，并在实际开发中更自信地使用它！</p>`,11))])}const b=p(t,[["render",i]]);export{B as __pageData,b as default};
